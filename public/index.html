<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé° –ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã - –ñ–µ—Ä–µ–±—å–µ–≤–∫–∞</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title"><i class="fas fa-star"></i> –ö–û–õ–ï–°–û –§–û–†–¢–£–ù–´ <i class="fas fa-star"></i></h1>
            <p class="subtitle">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∂–µ—Ä–µ–±—å–µ–≤–∫–∞ —Å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º –æ—Ç—Ä—è–¥–æ–≤</p>
        </div>
        
        <div class="status-info">
            <h3><i class="fas fa-info-circle"></i> –°—Ç–∞—Ç—É—Å –∂–µ—Ä–µ–±—å–µ–≤–∫–∏</h3>
            <p>–ü—Ä–æ–≤–µ–¥–µ–Ω–æ –∂–µ—Ä–µ–±—å–µ–≤–æ–∫: <span id="excludedSquadsCount">0</span></p>
        </div>
        
        
        <div class="stats-container">
            <div class="stat-card">
                <h3><i class="fas fa-users"></i> –í—Å–µ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h3>
                <div class="stat-number" id="totalParticipants">0</div>
                <p>–í —Ç–µ–∫—É—â–µ–º —Å–ø–∏—Å–∫–µ</p>
            </div>
            <div class="stat-card">
                <h3><i class="fas fa-user-friends"></i> –û—Å—Ç–∞–ª–æ—Å—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h3>
                <div class="stat-number" id="remainingParticipants">0</div>
                <p>–ì–æ—Ç–æ–≤—ã –∫ –∂–µ—Ä–µ–±—å–µ–≤–∫–µ</p>
            </div>
            <div class="stat-card">
                <h3><i class="fas fa-trophy"></i> –ü—Ä–æ–≤–µ–¥–µ–Ω–æ –∂–µ—Ä–µ–±—å–µ–≤–æ–∫</h3>
                <div class="stat-number" id="spinsCount">0</div>
                <p>–ò—Å—Ç–æ—Ä–∏—è –≤—ã–±–æ—Ä–æ–≤</p>
            </div>
        </div>
        
        <div class="wheel-container">
            <div class="wheel-background"></div>
            <div id="currentPerson" class="current-person">
                <i class="fas fa-play-circle"></i> –ù–∞–∂–º–∏—Ç–µ "–ö—Ä—É—Ç–∏—Ç—å –∫–æ–ª–µ—Å–æ" –¥–ª—è –Ω–∞—á–∞–ª–∞ –∂–µ—Ä–µ–±—å–µ–≤–∫–∏
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <div class="controls">
                <button id="spinButton" class="spin-btn" onclick="spinWheel()">
                    <i class="fas fa-redo-alt"></i> –ö—Ä—É—Ç–∏—Ç—å –∫–æ–ª–µ—Å–æ
                </button>
                <button id="resetButton" class="reset-btn" onclick="resetWheel()">
                    <i class="fas fa-sync-alt"></i> –°–±—Ä–æ—Å–∏—Ç—å –∂–µ—Ä–µ–±—å–µ–≤–∫—É
                </button>
            </div>
            
            <div id="result" class="result" style="display: none;">
                <div class="winner-glow"></div>
            </div>
        </div>

        <div class="participants-section">
            <h3><i class="fas fa-list-ul"></i> –û—Å—Ç–∞–≤—à–∏–µ—Å—è —É—á–∞—Å—Ç–Ω–∏–∫–∏</h3>
            <div class="participants-list" id="participantsList">
                <!-- –£—á–∞—Å—Ç–Ω–∏–∫–∏ –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
            </div>
        </div>

        <div class="history-section">
            <h3><i class="fas fa-history"></i> –ò—Å—Ç–æ—Ä–∏—è –∂–µ—Ä–µ–±—å–µ–≤–∫–∏</h3>
            <div class="history-list" id="historyList">
                <div class="history-item">
                    <span>–ñ–µ—Ä–µ–±—å–µ–≤–∫–∞ –µ—â–µ –Ω–µ –ø—Ä–æ–≤–æ–¥–∏–ª–∞—Å—å</span>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let isSpinning = false;
        let usedSquads = [];
        
        function updateExcludedSquadsCount() {
            document.getElementById('excludedSquadsCount').textContent = usedSquads.length;
        }
        
        function spinWheel() {
            if (isSpinning) return;
            
            isSpinning = true;
            document.getElementById('spinButton').disabled = true;
            document.getElementById('result').style.display = 'none';
            document.getElementById('progressFill').style.width = '0%';
            
            const spinBtn = document.getElementById('spinButton');
            spinBtn.classList.add('pulse');
            
            socket.emit('spin');
        }
        
        function resetWheel() {
            socket.emit('reset');
            createConfetti(30);
        }
        
        function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª', 'error');
                return;
            }
            
            if (!file.name.endsWith('.csv')) {
                showMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ CSV —Ñ–∞–π–ª', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('participantsFile', file);
            formData.append('append', 'false');
            
            const uploadBtn = document.querySelector('.upload-btn');
            const originalHtml = uploadBtn.innerHTML;
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞...';
            uploadBtn.disabled = true;
            
            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message, 'success');
                    fileInput.value = '';
                    createConfetti(20);
                } else {
                    showMessage(data.error, 'error');
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞', 'error');
            })
            .finally(() => {
                uploadBtn.innerHTML = originalHtml;
                uploadBtn.disabled = false;
            });
        }
        
        function showMessage(message, type) {
            const messageEl = document.getElementById('uploadMessage');
            messageEl.textContent = message;
            messageEl.className = `message ${type} shake`;
            
            setTimeout(() => {
                messageEl.textContent = '';
                messageEl.className = '';
            }, 5000);
        }
        
        function createConfetti(count) {
            for (let i = 0; i < count; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.background = getRandomColor();
                confetti.style.animation = `confettiFall ${Math.random() * 3 + 2}s linear forwards`;
                document.body.appendChild(confetti);
                
                setTimeout(() => {
                    confetti.remove();
                }, 5000);
            }
            
            const style = document.createElement('style');
            style.textContent = `
                @keyframes confettiFall {
                    0% { 
                        opacity: 1;
                        transform: translateY(-100px) rotate(0deg); 
                    }
                    100% { 
                        opacity: 0;
                        transform: translateY(100vh) rotate(360deg); 
                    }
                }
            `;
            document.head.appendChild(style);
        }
        
        function getRandomColor() {
            const colors = ['#ffeb3b', '#4CAF50', '#2196F3', '#f44336', '#9C27B0', '#FF9800'];
            return colors[Math.floor(Math.random() * colors.length)];
        }
        
        function playWinSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                
                oscillator.start();
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
                oscillator.stop(audioContext.currentTime + 1);
            } catch (e) {
                console.log('Web Audio API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
            }
        }
        
        socket.on('spinning', (data) => {
            const currentPersonEl = document.getElementById('currentPerson');
            const progressFill = document.getElementById('progressFill');
            
            currentPersonEl.innerHTML = 
                `<div class="spin-glow">
                    <i class="fas fa-spinner fa-spin"></i><br>
                    ${data.person.lastName} ${data.person.firstName} ${data.person.middleName}<br>
                    <small>–û—Ç—Ä—è–¥ ${data.person.squad}</small>
                </div>`;
            
            progressFill.style.width = data.progress + '%';
            
            if (data.iteration % 5 === 0 && navigator.vibrate) {
                navigator.vibrate(50);
            }
        });
        
        socket.on('result', (data) => {
            isSpinning = false;
            document.getElementById('spinButton').disabled = data.remainingParticipants.length === 0;
            document.getElementById('spinButton').classList.remove('pulse');
            
            usedSquads = data.usedSquads;
            updateExcludedSquadsCount();
            
            const resultEl = document.getElementById('result');
            resultEl.innerHTML = `
                <div class="winner-glow"></div>
                <i class="fas fa-trophy bounce" style="color: var(--accent);"></i><br>
                üéâ –ü–û–ë–ï–î–ò–¢–ï–õ–¨ üéâ<br>
                <strong>${data.winner.lastName} ${data.winner.firstName} ${data.winner.middleName}</strong><br>
                <span style="font-size: 0.8em;">–û—Ç—Ä—è–¥ ${data.winner.squad}</span>
            `;
            resultEl.style.display = 'block';
            
            updateParticipantsList(data.remainingParticipants);
            updateHistory(data.spinHistory);
            updateStats();
            
            createConfetti(100);
            playWinSound();
        });
        
        socket.on('initialData', (data) => {
            usedSquads = data.usedSquads;
            updateExcludedSquadsCount();
            updateParticipantsList(data.participants);
            updateHistory(data.spinHistory);
            updateStats();
        });
        
        socket.on('resetData', (data) => {
            usedSquads = data.usedSquads;
            updateExcludedSquadsCount();
            updateParticipantsList(data.participants);
            updateHistory(data.spinHistory);
            updateStats();
            
            document.getElementById('result').style.display = 'none';
            document.getElementById('currentPerson').innerHTML = 
                '<i class="fas fa-play-circle"></i> –ù–∞–∂–º–∏—Ç–µ "–ö—Ä—É—Ç–∏—Ç—å –∫–æ–ª–µ—Å–æ" –¥–ª—è –Ω–∞—á–∞–ª–∞ –∂–µ—Ä–µ–±—å–µ–≤–∫–∏';
            document.getElementById('spinButton').disabled = false;
            document.getElementById('progressFill').style.width = '0%';
        });
        
        socket.on('dataUpdated', (data) => {
            usedSquads = data.usedSquads;
            updateExcludedSquadsCount();
            updateParticipantsList(data.participants);
            updateHistory(data.spinHistory);
            updateStats();
            
            document.getElementById('result').style.display = 'none';
            document.getElementById('currentPerson').innerHTML = 
                '<i class="fas fa-play-circle"></i> –ù–∞–∂–º–∏—Ç–µ "–ö—Ä—É—Ç–∏—Ç—å –∫–æ–ª–µ—Å–æ" –¥–ª—è –Ω–∞—á–∞–ª–∞ –∂–µ—Ä–µ–±—å–µ–≤–∫–∏';
            document.getElementById('spinButton').disabled = false;
        });
        
        socket.on('usedSquadsUpdated', (squads) => {
            usedSquads = squads;
            updateExcludedSquadsCount();
        });
        
        socket.on('error', (message) => {
            isSpinning = false;
            document.getElementById('spinButton').disabled = true;
            document.getElementById('spinButton').classList.remove('pulse');
            showMessage(message, 'error');
        });
        
        function updateParticipantsList(participants) {
            const listEl = document.getElementById('participantsList');
            const count = participants.length;
            
            if (count === 0) {
                listEl.innerHTML = '<div class="participant-item"><span>–í—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –±—ã–ª–∏ –≤—ã–±—Ä–∞–Ω—ã</span></div>';
            } else {
                listEl.innerHTML = participants.map(p => 
                    `<div class="participant-item">
                        <span>${p.lastName} ${p.firstName} ${p.middleName}</span>
                        <span class="participant-squad">–û—Ç—Ä—è–¥ ${p.squad}</span>
                    </div>`
                ).join('');
            }
        }
        
        function updateHistory(history) {
            const historyListEl = document.getElementById('historyList');
            
            if (history.length === 0) {
                historyListEl.innerHTML = '<div class="history-item"><span>–ñ–µ—Ä–µ–±—å–µ–≤–∫–∞ –µ—â–µ –Ω–µ –ø—Ä–æ–≤–æ–¥–∏–ª–∞—Å—å</span></div>';
            } else {
                historyListEl.innerHTML = history.map(item => 
                    `<div class="history-item">
                        <div>
                            <strong>${item.winner.lastName} ${item.winner.firstName}</strong><br>
                            <small>–û—Ç—Ä—è–¥ ${item.winner.squad} ‚Ä¢ ${item.timestamp}</small>
                        </div>
                        <div class="participant-squad">–û—Å—Ç–∞–ª–æ—Å—å: ${item.remaining}</div>
                    </div>`
                ).join('');
            }
        }
        
        function updateStats() {
            const participants = document.querySelectorAll('.participant-item:not(:only-child)').length;
            document.getElementById('totalParticipants').textContent = participants;
            document.getElementById('remainingParticipants').textContent = participants;
            document.getElementById('spinsCount').textContent = document.querySelectorAll('.history-item:not(:only-child)').length;
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            createConfetti(30);
            updateExcludedSquadsCount();
        });
    </script>
</body>
</html>