<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé° –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <a href="/" class="back-link">
            <i class="fas fa-arrow-left"></i> –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫–æ–ª–µ—Å—É —Ñ–æ—Ä—Ç—É–Ω—ã
        </a>
        
        <div class="header">
            <h1 class="title"><i class="fas fa-cogs"></i> –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨</h1>
            <p class="subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ –∏ –æ—Ç—Ä—è–¥–∞–º–∏</p>
        </div>
        
        <div class="admin-nav">
            <button class="nav-btn active" onclick="showSection('upload')">
                <i class="fas fa-file-upload"></i> –ó–∞–≥—Ä—É–∑–∫–∞ CSV
            </button>
            <button class="nav-btn" onclick="showSection('redistribute')">
                <i class="fas fa-random"></i> –ü–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
            </button>
            <button class="nav-btn" onclick="showSection('manage')">
                <i class="fas fa-users-cog"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏
            </button>
            <button class="nav-btn" onclick="showSection('dragdrop')">
                <i class="fas fa-arrows-alt"></i> Drag & Drop
            </button>
            <button class="nav-btn" onclick="showSection('excluded')">
                <i class="fas fa-ban"></i> –ò—Å–∫–ª—é—á–µ–Ω–Ω—ã–µ –æ—Ç—Ä—è–¥—ã
            </button>
            <button class="nav-btn" onclick="showSection('export')">
                <i class="fas fa-download"></i> –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
            </button>
        </div>
        
        <div id="messageContainer"></div>
        
        <div id="upload" class="section active">
            <div class="card">
                <h3><i class="fas fa-file-csv"></i> –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h3>
                <div class="file-upload">
                    <input type="file" id="fileInput" accept=".csv">
                    <button class="btn btn-info" onclick="uploadFile(false)">
                        <i class="fas fa-cloud-upload-alt"></i> –ó–∞–º–µ–Ω–∏—Ç—å —Å–ø–∏—Å–æ–∫
                    </button>
                    <button class="btn btn-info" onclick="uploadFile(true)">
                        <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –∫ —Å–ø–∏—Å–∫—É
                    </button>
                </div>
                <div class="file-format">
                    <i class="fas fa-info-circle"></i> –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: CSV —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏ ; , –∏–ª–∏ tab<br>
                    <i class="fas fa-info-circle"></i> –§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö: —Ñ–∞–º–∏–ª–∏—è;–∏–º—è;–æ—Ç—á–µ—Å—Ç–≤–æ;–æ—Ç—Ä—è–¥ (–æ—Ç—Ä—è–¥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 9)
                </div>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-user-plus"></i> –î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞ –≤—Ä—É—á–Ω—É—é</h3>
                <form id="addParticipantForm">
                    <div class="form-group">
                        <label for="lastName">–§–∞–º–∏–ª–∏—è:</label>
                        <input type="text" id="lastName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="firstName">–ò–º—è:</label>
                        <input type="text" id="firstName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="middleName">–û—Ç—á–µ—Å—Ç–≤–æ:</label>
                        <input type="text" id="middleName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="squad">–û—Ç—Ä—è–¥:</label>
                        <input type="number" id="squad" class="form-control" min="1" max="99" value="9" required>
                    </div>
                    <button type="submit" class="btn">
                        <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞
                    </button>
                </form>
            </div>
        </div>
        
        <div id="redistribute" class="section">
            <div class="card">
                <h3><i class="fas fa-random"></i> –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ</h3>
                <div class="form-group">
                    <label for="squadCount">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç—Ä—è–¥–æ–≤ (–æ—Ç 1 –¥–æ <span id="maxSquads">10</span>):</label>
                    <select id="squadCount" class="form-control">
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ --</option>
                    </select>
                </div>
                <button class="btn btn-warning" onclick="redistributeSquads()">
                    <i class="fas fa-random"></i> –ü–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                </button>
                <div id="redistributeMessage"></div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-item">
                    <h4>–í—Å–µ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h4>
                    <div class="stat-value" id="totalParticipants">0</div>
                </div>
                <div class="stat-item">
                    <h4>–¢–µ–∫—É—â–∏—Ö –æ—Ç—Ä—è–¥–æ–≤</h4>
                    <div class="stat-value" id="squadsCount">0</div>
                </div>
                <div class="stat-item">
                    <h4>–ú–∞–∫—Å–∏–º—É–º –æ—Ç—Ä—è–¥–æ–≤</h4>
                    <div class="stat-value" id="maxSquadsCount">0</div>
                </div>
            </div>

            <div class="card">
                <h3><i class="fas fa-info-circle"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏</h3>
                <div id="distributionInfo">
                    <p>–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç—Ä—è–¥–æ–≤ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏</p>
                </div>
            </div>
        </div>
        
        <div id="manage" class="section">
            <div class="card">
                <h3><i class="fas fa-list"></i> –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h3>
                <div class="form-group">
                    <input type="text" id="searchParticipants" class="form-control" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ñ–∞–º–∏–ª–∏–∏, –∏–º–µ–Ω–∏ –∏–ª–∏ –æ—Ç—á–µ—Å—Ç–≤—É..." onkeyup="searchParticipants()">
                </div>
                <div id="allParticipantsList" class="participant-list">
                    <!-- –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
                </div>
            </div>
        </div>
        
        <div id="dragdrop" class="section">
            <div class="card">
                <h3><i class="fas fa-arrows-alt"></i> –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –º–µ–∂–¥—É –æ—Ç—Ä—è–¥–∞–º–∏</h3>
                <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –º–µ–∂–¥—É –∫–æ–ª–æ–Ω–∫–∞–º–∏ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏—Ö –æ—Ç—Ä—è–¥–∞</p>
                
                <div class="squads-container" id="squadsContainer">
                    <!-- –ö–æ–ª–æ–Ω–∫–∏ –æ—Ç—Ä—è–¥–æ–≤ –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
                </div>
            </div>
        </div>
        
        <div id="excluded" class="section">
            <div class="card">
                <h3><i class="fas fa-ban"></i> –ò—Å–∫–ª—é—á–µ–Ω–Ω—ã–µ –æ—Ç—Ä—è–¥—ã</h3>
                <p>–û—Ç—Ä—è–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∏—Å–∫–ª—é—á–µ–Ω—ã –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∂–µ—Ä–µ–±—å–µ–≤–∫–∏ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ</p>
                
                <div class="stats-grid">
                    <div class="stat-item">
                        <h4>–ò—Å–∫–ª—é—á–µ–Ω–æ –æ—Ç—Ä—è–¥–æ–≤</h4>
                        <div class="stat-value" id="excludedSquadsCount">0</div>
                    </div>
                    <div class="stat-item">
                        <h4>–í—Å–µ–≥–æ –æ—Ç—Ä—è–¥–æ–≤</h4>
                        <div class="stat-value" id="totalSquadsCount">0</div>
                    </div>
                    <div class="stat-item">
                        <h4>–î–æ—Å—Ç—É–ø–Ω–æ –æ—Ç—Ä—è–¥–æ–≤</h4>
                        <div class="stat-value" id="availableSquadsCount">0</div>
                    </div>
                </div>
                
                <div class="squads-list" id="excludedSquadsList" style="margin-top: 20px;">
                    <!-- –°–ø–∏—Å–æ–∫ –∏—Å–∫–ª—é—á–µ–Ω–Ω—ã—Ö –æ—Ç—Ä—è–¥–æ–≤ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-warning" onclick="resetUsedSquads()">
                        <i class="fas fa-sync-alt"></i> –°–±—Ä–æ—Å–∏—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–Ω—ã–µ –æ—Ç—Ä—è–¥—ã
                    </button>
                    <p style="margin-top: 10px; font-size: 0.9em; opacity: 0.8;">
                        <i class="fas fa-info-circle"></i> –°–±—Ä–æ—Å –ø–æ–∑–≤–æ–ª–∏—Ç —Å–Ω–æ–≤–∞ —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –∂–µ—Ä–µ–±—å–µ–≤–∫–µ –≤—Å–µ–º –æ—Ç—Ä—è–¥–∞–º
                    </p>
                </div>
            </div>
        </div>
        
        <div id="export" class="section">
            <div class="card">
                <h3><i class="fas fa-download"></i> –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h3>
                <div class="export-section">
                    <h4><i class="fas fa-file-csv"></i> –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV</h4>
                    <p>–í—ã–≥—Ä—É–∑–∏—Ç–µ —Ç–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ CSV –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏</p>
                    <button class="btn btn-success" onclick="exportToCSV()">
                        <i class="fas fa-download"></i> –í—ã–≥—Ä—É–∑–∏—Ç—å CSV
                    </button>
                    <div class="file-format" style="margin-top: 15px;">
                        <i class="fas fa-info-circle"></i> –§–æ—Ä–º–∞—Ç: —Ñ–∞–º–∏–ª–∏—è;–∏–º—è;–æ—Ç—á–µ—Å—Ç–≤–æ;–æ—Ç—Ä—è–¥
                    </div>
                </div>

                <div class="export-section" style="margin-top: 20px;">
                    <h4><i class="fas fa-file-excel"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h4>
                    <p>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–∫—É—â–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Å–∏—Å—Ç–µ–º—ã</p>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <h4>–í—Å–µ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h4>
                            <div class="stat-value" id="exportTotalParticipants">0</div>
                        </div>
                        <div class="stat-item">
                            <h4>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç—Ä—è–¥–æ–≤</h4>
                            <div class="stat-value" id="exportSquadsCount">0</div>
                        </div>
                        <div class="stat-item">
                            <h4>–ò—Å–∫–ª—é—á–µ–Ω–æ –æ—Ç—Ä—è–¥–æ–≤</h4>
                            <div class="stat-value" id="exportExcludedCount">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let allParticipants = [];
        let maxSquads = 10;
        
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');
            
            if (sectionId === 'dragdrop') {
                renderSquadsDragDrop();
            } else if (sectionId === 'redistribute') {
                updateDistributionInfo();
            }
        }
        
        function uploadFile(append) {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª', 'error');
                return;
            }
            
            if (!file.name.endsWith('.csv')) {
                showMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ CSV —Ñ–∞–π–ª', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('participantsFile', file);
            formData.append('append', append.toString());
            
            const uploadBtn = event.target;
            const originalHtml = uploadBtn.innerHTML;
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞...';
            uploadBtn.disabled = true;
            
            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message, 'success');
                    fileInput.value = '';
                    updateStats();
                    renderAllParticipants();
                    updateDistributionInfo();
                } else {
                    showMessage(data.error, 'error');
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞', 'error');
            })
            .finally(() => {
                uploadBtn.innerHTML = originalHtml;
                uploadBtn.disabled = false;
            });
        }
        
        document.getElementById('addParticipantForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const lastName = document.getElementById('lastName').value;
            const firstName = document.getElementById('firstName').value;
            const middleName = document.getElementById('middleName').value;
            const squad = document.getElementById('squad').value;
            
            fetch('/add-participant', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ lastName, firstName, middleName, squad })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message, 'success');
                    document.getElementById('addParticipantForm').reset();
                    document.getElementById('squad').value = '9';
                    updateStats();
                    renderAllParticipants();
                    updateDistributionInfo();
                } else {
                    showMessage(data.error, 'error');
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞', 'error');
            });
        });
        
        function redistributeSquads() {
            const squadCount = document.getElementById('squadCount').value;
            
            if (!squadCount) {
                showMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç—Ä—è–¥–æ–≤', 'error');
                return;
            }
            
            fetch('/redistribute-squads', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ squadCount: parseInt(squadCount) })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message, 'success');
                    updateStats();
                    renderAllParticipants();
                    renderSquadsDragDrop();
                    updateDistributionInfo();
                } else {
                    showMessage(data.error, 'error');
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏', 'error');
            });
        }
        
        function updateStats() {
            const total = allParticipants.length;
            const squads = [...new Set(allParticipants.map(p => p.squad))].length;
            const maxSquadsElement = document.getElementById('maxSquadsCount');
            
            document.getElementById('totalParticipants').textContent = total;
            document.getElementById('squadsCount').textContent = squads;
            document.getElementById('exportTotalParticipants').textContent = total;
            document.getElementById('exportSquadsCount').textContent = squads;
            
            if (maxSquadsElement) {
                maxSquadsElement.textContent = maxSquads;
            }
        }
        
        function renderAllParticipants() {
            const container = document.getElementById('allParticipantsList');
            container.innerHTML = '';
            
            allParticipants.sort((a, b) => a.squad - b.squad || a.lastName.localeCompare(b.lastName));
            
            allParticipants.forEach(participant => {
                const item = document.createElement('div');
                item.className = 'participant-item';
                item.innerHTML = `
                    <div>
                        <div class="participant-name">
                            ${participant.lastName} ${participant.firstName} ${participant.middleName}
                        </div>
                        <div>–û—Ç—Ä—è–¥: ${participant.squad}</div>
                    </div>
                    <div class="participant-actions">
                        <button class="action-btn" onclick="editParticipant(${participant.id})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn" onclick="deleteParticipant(${participant.id})" title="–£–¥–∞–ª–∏—Ç—å">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                container.appendChild(item);
            });
        }
        
        function searchParticipants() {
            const searchTerm = document.getElementById('searchParticipants').value.toLowerCase();
            const items = document.querySelectorAll('#allParticipantsList .participant-item');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        function renderSquadsDragDrop() {
            const container = document.getElementById('squadsContainer');
            container.innerHTML = '';
            
            const squads = [...new Set(allParticipants.map(p => p.squad))].sort((a, b) => a - b);
            
            squads.forEach(squad => {
                const squadParticipants = allParticipants.filter(p => p.squad === squad);
                
                const squadColumn = document.createElement('div');
                squadColumn.className = 'squad-column';
                squadColumn.innerHTML = `
                    <div class="squad-header">
                        <div class="squad-title">–û—Ç—Ä—è–¥ ${squad}</div>
                        <div class="squad-count">${squadParticipants.length} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
                    </div>
                    <div class="participant-list" id="squad-${squad}" 
                         ondrop="drop(event)" ondragover="allowDrop(event)">
                        ${squadParticipants.map(p => `
                            <div class="participant-item" draggable="true" 
                                 ondragstart="drag(event)" id="participant-${p.id}">
                                <div class="participant-name">
                                    ${p.lastName} ${p.firstName} ${p.middleName}
                                </div>
                            </div>
                        `).join('')}
                        <div class="drop-zone">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞ —Å—é–¥–∞</div>
                    </div>
                `;
                container.appendChild(squadColumn);
            });
        }
        
        function allowDrop(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.add('drag-over');
        }
        
        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.id);
            ev.target.classList.add('dragging');
        }
        
        function drop(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.remove('drag-over');
            
            const data = ev.dataTransfer.getData("text");
            const draggedElement = document.getElementById(data);
            const targetSquad = ev.currentTarget.id.replace('squad-', '');
            
            if (draggedElement) {
                const participantId = parseInt(data.replace('participant-', ''));
                const participant = allParticipants.find(p => p.id === participantId);
                
                if (participant && participant.squad !== targetSquad) {
                    fetch('/update-participant-squad', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            participantId: participantId,
                            newSquad: targetSquad
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showMessage(`–£—á–∞—Å—Ç–Ω–∏–∫ –ø–µ—Ä–µ–º–µ—â–µ–Ω –≤ –æ—Ç—Ä—è–¥ ${targetSquad}`, 'success');
                            renderSquadsDragDrop();
                        } else {
                            showMessage(data.error, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('–û—à–∏–±–∫–∞:', error);
                        showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞', 'error');
                    });
                }
            }
            
            document.querySelectorAll('.participant-item').forEach(item => {
                item.classList.remove('dragging');
            });
        }
        
        function deleteParticipant(id) {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞?')) {
                fetch(`/participant/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showMessage(data.message, 'success');
                        renderAllParticipants();
                        renderSquadsDragDrop();
                        updateStats();
                        updateDistributionInfo();
                    } else {
                        showMessage(data.error, 'error');
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞:', error);
                    showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞', 'error');
                });
            }
        }
        
        function editParticipant(id) {
            const participant = allParticipants.find(p => p.id === id);
            if (participant) {
                const newSquad = prompt(`–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –æ—Ç—Ä—è–¥ –¥–ª—è ${participant.lastName} ${participant.firstName}:`, participant.squad);
                if (newSquad && newSquad !== participant.squad) {
                    fetch('/update-participant-squad', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            participantId: id,
                            newSquad: newSquad
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showMessage(data.message, 'success');
                            renderAllParticipants();
                            renderSquadsDragDrop();
                            updateDistributionInfo();
                        } else {
                            showMessage(data.error, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('–û—à–∏–±–∫–∞:', error);
                        showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞', 'error');
                    });
                }
            }
        }
        
        function resetUsedSquads() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –∏—Å–∫–ª—é—á–µ–Ω–Ω—ã–µ –æ—Ç—Ä—è–¥—ã? –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –≤—Å–µ–º –æ—Ç—Ä—è–¥–∞–º —Å–Ω–æ–≤–∞ —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –∂–µ—Ä–µ–±—å–µ–≤–∫–µ.')) {
                fetch('/reset-used-squads', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showMessage(data.message, 'success');
                        renderExcludedSquads([]);
                    } else {
                        showMessage(data.error, 'error');
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞:', error);
                    showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –æ—Ç—Ä—è–¥–æ–≤', 'error');
                });
            }
        }
        
        function renderExcludedSquads(excludedSquads) {
            const container = document.getElementById('excludedSquadsList');
            const countElement = document.getElementById('excludedSquadsCount');
            const totalSquadsElement = document.getElementById('totalSquadsCount');
            const availableSquadsElement = document.getElementById('availableSquadsCount');
            const exportExcludedElement = document.getElementById('exportExcludedCount');
            
            const totalSquads = [...new Set(allParticipants.map(p => p.squad))].length;
            const availableSquads = totalSquads - excludedSquads.length;
            
            countElement.textContent = excludedSquads.length;
            totalSquadsElement.textContent = totalSquads;
            availableSquadsElement.textContent = availableSquads;
            exportExcludedElement.textContent = excludedSquads.length;
            
            if (excludedSquads.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                        <i class="fas fa-check-circle" style="font-size: 3em; opacity: 0.5; margin-bottom: 15px;"></i>
                        <p>–ù–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–Ω—ã—Ö –æ—Ç—Ä—è–¥–æ–≤</p>
                        <p style="font-size: 0.9em; opacity: 0.7;">–í—Å–µ –æ—Ç—Ä—è–¥—ã –º–æ–≥—É—Ç —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –∂–µ—Ä–µ–±—å–µ–≤–∫–µ</p>
                    </div>
                `;
            } else {
                container.innerHTML = excludedSquads.map(squad => `
                    <div class="squad-badge">
                        <i class="fas fa-ban"></i> –û—Ç—Ä—è–¥ ${squad}
                    </div>
                `).join('');
            }
        }
        
        function exportToCSV() {
            window.open('/export-csv', '_blank');
        }
        
        function updateDistributionInfo() {
            const squadCountSelect = document.getElementById('squadCount');
            const selectedCount = squadCountSelect.value;
            const infoContainer = document.getElementById('distributionInfo');
            
            if (!selectedCount) {
                infoContainer.innerHTML = '<p>–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç—Ä—è–¥–æ–≤ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏</p>';
                return;
            }
            
            const totalParticipants = allParticipants.length;
            const requestedSquads = parseInt(selectedCount);
            const actualSquads = Math.min(requestedSquads, totalParticipants);
            const basePerSquad = Math.floor(totalParticipants / actualSquads);
            const remainder = totalParticipants % actualSquads;
            
            let infoHTML = `
                <p><strong>–ó–∞–ø—Ä–æ—à–µ–Ω–æ –æ—Ç—Ä—è–¥–æ–≤:</strong> ${requestedSquads}</p>
                <p><strong>–ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ –æ—Ç—Ä—è–¥–æ–≤:</strong> ${actualSquads}</p>
                <p><strong>–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ –æ—Ç—Ä—è–¥–∞—Ö:</strong></p>
                <ul>
            `;
            
            for (let i = 1; i <= actualSquads; i++) {
                const participantsInSquad = i === actualSquads ? basePerSquad + remainder : basePerSquad;
                infoHTML += `<li>–û—Ç—Ä—è–¥ ${i}: ${participantsInSquad} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</li>`;
            }
            
            infoHTML += `</ul>`;
            
            if (requestedSquads > totalParticipants) {
                infoHTML += `<p class="error" style="color: var(--danger); margin-top: 10px;">
                    <i class="fas fa-exclamation-triangle"></i> 
                    –í–Ω–∏–º–∞–Ω–∏–µ: –ó–∞–ø—Ä–æ—à–µ–Ω–æ –±–æ–ª—å—à–µ –æ—Ç—Ä—è–¥–æ–≤ —á–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤. –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ ${actualSquads} –æ—Ç—Ä—è–¥–æ–≤.
                </p>`;
            }
            
            infoContainer.innerHTML = infoHTML;
        }
        
        function showMessage(message, type) {
            const container = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                ${message}
            `;
            container.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }
        
        socket.on('initialData', (data) => {
            allParticipants = data.participants;
            updateStats();
            renderAllParticipants();
            renderSquadsDragDrop();
            renderExcludedSquads(data.usedSquads);
            
            // –ü–æ–ª—É—á–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç—Ä—è–¥–æ–≤
            fetch('/possible-squads')
                .then(response => response.json())
                .then(squadsData => {
                    const possibleCounts = squadsData.possibleCounts;
                    maxSquads = possibleCounts.length > 0 ? Math.max(...possibleCounts) : 10;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º UI
                    document.getElementById('maxSquads').textContent = maxSquads;
                    document.getElementById('maxSquadsCount').textContent = maxSquads;
                    
                    const squadSelect = document.getElementById('squadCount');
                    squadSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ --</option>';
                    
                    possibleCounts.forEach(count => {
                        const option = document.createElement('option');
                        option.value = count;
                        const participantsPerSquad = Math.floor(allParticipants.length / count);
                        const remainder = allParticipants.length % count;
                        let description = `${count} –æ—Ç—Ä—è–¥–æ–≤`;
                        if (remainder === 0) {
                            description += ` (–ø–æ ${participantsPerSquad} —á–µ–ª–æ–≤–µ–∫)`;
                        } else {
                            description += ` (–ø–æ ${participantsPerSquad} —á–µ–ª–æ–≤–µ–∫ + ${remainder} –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–º)`;
                        }
                        option.textContent = description;
                        squadSelect.appendChild(option);
                    });
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—ã–±–æ—Ä–∞
                    squadSelect.addEventListener('change', updateDistributionInfo);
                });
        });
        
        socket.on('participantAdded', (data) => {
            allParticipants = data.participants;
            updateStats();
            renderAllParticipants();
            renderSquadsDragDrop();
            updateDistributionInfo();
        });
        
        socket.on('participantUpdated', (data) => {
            allParticipants = data.participants;
            updateStats();
            renderAllParticipants();
            renderSquadsDragDrop();
            updateDistributionInfo();
        });
        
        socket.on('participantDeleted', (data) => {
            allParticipants = data.participants;
            updateStats();
            renderAllParticipants();
            renderSquadsDragDrop();
            updateDistributionInfo();
        });
        
        socket.on('usedSquadsUpdated', (squads) => {
            renderExcludedSquads(squads);
        });
        
        socket.on('usedSquadsReset', (data) => {
            renderExcludedSquads(data.usedSquads);
        });
        
        document.addEventListener('dragend', function() {
            document.querySelectorAll('.participant-item').forEach(item => {
                item.classList.remove('dragging');
            });
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.classList.remove('drag-over');
            });
        });
    </script>
</body>
</html>